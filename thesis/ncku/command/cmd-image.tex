
% Some helper function about insert image

% 用\begin{figure} .. \end{figure}
% 可能會出現問題
% http://www.tex.ac.uk/cgi-bin/texfaq2html?label=ouparmd

\DeclareDocumentCommand{\SetImageCaption}{G{\empty}}
{
  \ifthenelse{\equal{#1}{\empty}}
  {}
  {\IfNoValueF{#1}{\caption{#1}}}
} % End of \DeclareDocumentCommand{}

\DeclareDocumentCommand{\SetImageLabel}{G{\empty}}
{
  \ifthenelse{\equal{#1}{\empty}}
  {}
  {\IfNoValueF{#1}{\label{#1}}}
} % End of \DeclareDocumentCommand{}

\pgfkeys
{
  /InsertImage/.is family, /InsertImage,
  default/.style = 
  {
    scale = 1.0,
    angle = 0,
    caption = \empty,
    label = \empty,
    align = \empty,
  },
  scale/.estore in = \InsertImageValueScale,
  angle/.estore in = \InsertImageValueAngle,
  caption/.estore in = \InsertImageValueCaption,
  label/.estore in = \InsertImageValueLabel,
  align/.estore in = \InsertImageValueAlign,
} % End of \pgfkeys{}

% Insert a single image
\newcommand{\InsertImage}[2][\empty]
{
  % Parse the input
  \pgfkeys{/InsertImage, default, #1}
  %
  % Debug if needed
%  Scale: \InsertImageValueScale\\
%  Angle: \InsertImageValueAngle\\
%  Caption: \InsertImageValueCaption\\
%  Label: \InsertImageValueLabel\\
%  Align: \InsertImageValueAlign\\
%  \ifthenelse{\equal{#2}{\empty}}
%    {Path: -EMPTY-\\}{Path: #2\\}
%  \IfNoValueF{#2}{Path: #2\\}
  %
  %
  % Check any caption first
  \ifthenelse{\equal{\InsertImageValueCaption}{\empty}}
  { %
    %
    %No Caption
    %
    % Align
    \ifthenelse{\equal{\InsertImageValueAlign}{center}}
      {\begin{center}}{}
    % Insert image
    \includegraphics
      [scale=\InsertImageValueScale,
        angle=\InsertImageValueAngle]{#2}
    % Align
    \ifthenelse{\equal{\InsertImageValueAlign}{center}}
      {\end{center}}{}
  } % End of if{}
  { %
    %
    %Have Caption
    %
    \begin{figure}[h]
      % Do center if needed
      \ifthenelse{\equal{\InsertImageValueAlign}{center}}
        {\center}{}
      % Insert image
      \includegraphics
        [scale=\InsertImageValueScale,
          angle=\InsertImageValueAngle]{#2}
      % Set Caption
      \SetImageCaption{\InsertImageValueCaption}
      % Set Label
      \ifthenelse{\equal{\InsertImageValueCaption}{\empty}}
        {}{\SetImageLabel{\InsertImageValueLabel}}
    \end{figure}
  } % End of else{}
} % End of \newcommand{}

% Insert a single image, but place it in center
\newcommand{\InsertCenterImage}[2][\empty]
{
  \InsertImage[#1, align=center]{#2}
} % End of \newcommand{}

% For multi images
\newcommand\MultiImagesPerRow{1}
\newcommand{\SetMultiImagesPerRow}[1]
  {\renewcommand{\MultiImagesPerRow}{#1}}
\newcommand{\GetMultiImagesPerRow}[0]{\MultiImagesPerRow}

%add desired spacing between images, e. g. ~, \quad, \qquad etc.
%(or a blank line to force the subfigure onto a new line)
\newcommand{\SubfigureBreakSpaceLine}[1]
{
  \ifthenelse{\equal{\intcalcMod{
    \GetMultiImageId - 1}{\GetMultiImagesPerRow}}{0}}%
  {%
    % Echo blank line
    %

  } % End of if{}
  {%
    ~
  } % End of else{}
} % End of \newcommand{}

% Confingure the main image
\DeclareDocumentCommand{\SetMultiImageRoot}{m g g}
{
  % Set per row
  \FPeval{\MultiImagesPerRow}{clip(#1)} %
} % End of \newcommand{}

\DeclareDocumentCommand{\SetMultiImageRootCaptionAndLabel}{m g g}
{
  \SetImageCaption{#2} %
  \SetImageLabel{#3} %
} % End of \newcommand{}

% Low-level insert image
\newcommand\ImageRotateAngle{0}
\newcommand{\SetImageRotateAngle}[1]
  {\renewcommand{\ImageRotateAngle}{#1}}
\newcommand{\GetImageRotateAngle}[0]{\ImageRotateAngle}

\newcommand{\InsertSubfigureImage}[5]
{%
  \begin{subfigure}[b]{\WidthOfImagePerRow\textwidth}%
    \center
    \includegraphics[scale=#1, angle=#5]{#2}
    \SetImageCaption{#3}
    \SetImageLabel{#4}
  \end{subfigure}%
} % End of \newcommand{}

\newcommand{\InsertMultiImageInterface}[2]
{
  \ifthenelse{\equal{#2}{\empty}}
    {}
    {
      \SetMultiImageId{#1}
      \SubfigureBreakSpaceLine{#1}
      \ifthenelse{\equal{\GetMultiImagesPerRow}{1}}%
      {%
        \FPeval{\WidthOfImagePerRow}{1.0} %
      } % End of if{}
      {%
        \ifthenelse{\equal{\GetMultiImageId}{\GetMultiImageTotalValue}}%
        {%
          \FPeval{\WidthOfImagePerRow}{1.0} %
        } % End of if{}
        {%
          \FPeval{\WidthOfImagePerRow}{clip(clip(1 / \GetMultiImagesPerRow) - 0.1)} %
        } % End of else{}
      } % End of else{}
      \InsertMultiImageLL#2
    } % End of else{}
} % End of \newcommand{}

\DeclareDocumentCommand{\InsertMultiImageLL}{m m g g g}
{
  \SetImageRotateAngle{0}
  \IfNoValueF{#5}{\SetImageRotateAngle{#5}}
  \InsertSubfigureImage{#1}{#2}{#3}{#4}{\ImageRotateAngle}%
} % End of \DeclareDocumentCommand{}

\newcommand\MultiImageTotalValue{0}
\newcommand{\SetMultiImageTotalValue}[1]
  {\renewcommand{\MultiImageTotalValue}{#1}}
\newcommand{\GetMultiImageTotalValue}[0]{\MultiImageTotalValue}

\newcommand\MultiImageId{0}
\newcommand{\SetMultiImageId}[1]
  {\renewcommand{\MultiImageId}{#1}}
\newcommand{\GetMultiImageId}[0]{\MultiImageId}

% Insert multi-image
% Arg: 1st: Table configure
%      2~9th: Images (Max 8 Images)
%
% ---------------------------------------
% 使用 \InsertMultiImageLL#2
% 是跟 \InsertMultiImageLL{#2} 不一樣的
% 直接連接#2是指把#2整個當成function的所有參數
% 而{#2}是指把#2當成單一個參數傳給function
% ---------------------------------------
%
\DeclareDocumentCommand{\InsertMultiImages}{%
  G{\empty} G{\empty} G{\empty} %
  G{\empty} G{\empty} G{\empty} %
  G{\empty} G{\empty} G{\empty}}
{
  %Set Multi Image Total
  \ifthenelse{\equal{#2}{\empty}}{}{\SetMultiImageTotalValue{1}}
  \ifthenelse{\equal{#3}{\empty}}{}{\SetMultiImageTotalValue{2}}
  \ifthenelse{\equal{#4}{\empty}}{}{\SetMultiImageTotalValue{3}}
  \ifthenelse{\equal{#5}{\empty}}{}{\SetMultiImageTotalValue{4}}
  \ifthenelse{\equal{#6}{\empty}}{}{\SetMultiImageTotalValue{5}}
  \ifthenelse{\equal{#7}{\empty}}{}{\SetMultiImageTotalValue{6}}
  \ifthenelse{\equal{#8}{\empty}}{}{\SetMultiImageTotalValue{7}}
  \ifthenelse{\equal{#9}{\empty}}{}{\SetMultiImageTotalValue{8}}

  \begin{figure}[hbtp]
    \centering
    \SetMultiImageRoot#1
    % Image 1
    \InsertMultiImageInterface{1}{#2}
    % Image 2
    \InsertMultiImageInterface{2}{#3}
    % Image 3
    \InsertMultiImageInterface{3}{#4}
    % Image 4
    \InsertMultiImageInterface{4}{#5}
    % Image 5
    \InsertMultiImageInterface{5}{#6}
    % Image 6
    \InsertMultiImageInterface{6}{#7}
    % Image 7
    \InsertMultiImageInterface{7}{#8}
    % Image 8
    \InsertMultiImageInterface{8}{#9}
    \SetMultiImageRootCaptionAndLabel#1
  \end{figure}
} % End of \DeclareDocumentCommand{}

% ----------------------------------------------------------------------------

\DeclareDocumentCommand{\TestImages}{%
  O{1.0} O{0} m}
{
        #1 \\
        #2 \\
        #3 \\
} % End of \DeclareDocumentCommand{}

% http://tex.stackexchange.com/questions/34312/how-to-create-a-command-with-key-values

\pgfkeys
{
  /InsertImageB/.is family, /InsertImageB,
  default/.style = 
  {
    scale = 1.0,
    angle = 0,
    caption = \empty,
    label = \empty
  },
  scale/.estore in = \InsertImageBScale,
  angle/.estore in = \InsertImageBAngle,
  caption/.estore in = \InsertImageBCaption,
  label/.estore in = \InsertImageBLabel,
} % End of \pgfkeys{}

\pgfkeys
{
  /InsertImageCD/.is family, /InsertImageCD,
  default/.style = 
  {
    scale = 1.0,
    angle = 0,
    caption = \empty,
    label = \empty
  },
  scale/.estore in = \InsertImageCDScale,
  angle/.estore in = \InsertImageCDAngle,
  caption/.estore in = \InsertImageCDCaption,
  label/.estore in = \InsertImageCDLabel,
} % End of \pgfkeys{}

\newcommand\InsertImageB[2][\empty]
{
  \pgfkeys{/InsertImageB, default, #1}%
  Scale: \InsertImageBScale\\
  Angle: \InsertImageBAngle\\
  caption: \InsertImageBCaption\\
  label: \InsertImageBLabel\\
  Path: #2\\
}

\newcommand\InsertImageCD[2][\empty]
{
  \pgfkeys{/InsertImageCD, default, #1}%
  Scale: \InsertImageCDScale\\
  Angle: \InsertImageCDAngle\\
  caption: \InsertImageCDCaption\\
  label: \InsertImageCDLabel\\
  Path: #2\\
}
