
% Some helper function about insert image

% 用\begin{figure} .. \end{figure}
% 可能會出現問題
% http://www.tex.ac.uk/cgi-bin/texfaq2html?label=ouparmd

\DeclareDocumentCommand{\SetImageCaption}{G{\empty}}
{
  \ifthenelse{\equal{#1}{\empty}}
  {}
  {\IfNoValueF{#1}{\caption{#1}}}
} % End of \newcommand{}

\DeclareDocumentCommand{\SetImageLabel}{G{\empty}}
{
  \ifthenelse{\equal{#1}{\empty}}
  {}
  {\IfNoValueF{#1}{\label{#1}}}
} % End of \newcommand{}

% Insert a single image
\DeclareDocumentCommand{\InsertImage}
  {G{1.0} m G{\empty} G{\empty} G{0} G{\empty}}
{
  \begin{figure}[hbtp]

    % Do center if needed
    \ifthenelse{\equal{#6}{\empty}}{}{\center}

    % Insert image
    \includegraphics[scale=#1, angle=#5]{#2}

    % Set other thing
    \SetImageCaption{#3}
    \SetImageLabel{#4}
  \end{figure}
} % End of \DeclareDocumentCommand{}

% Insert a single image, but place it in center
\DeclareDocumentCommand{\InsertCenterImage}
  {G{1.0} m G{\empty} G{\empty} G{0}}
{
  \InsertImage{#1}{#2}{#3}{#4}{#5}{center}
} % End of \DeclareDocumentCommand{}

% For multi images
\newcommand\MultiImagesPerRow{1}
\newcommand{\SetMultiImagesPerRow}[1]
  {\renewcommand{\MultiImagesPerRow}{#1}}
\newcommand{\GetMultiImagesPerRow}[0]{\MultiImagesPerRow}

%add desired spacing between images, e. g. ~, \quad, \qquad etc.
%(or a blank line to force the subfigure onto a new line)
\newcommand{\SubfigureBreakSpaceLine}[1]
{
  \ifthenelse{\equal{\intcalcMod{#1 - 1}{\GetMultiImagesPerRow}}{0}}%
  {%
    % Echo blank line
    %

  } % End of if{}
  {%
    ~
  } % End of else{}
} % End of \newcommand{}

% Confingure the main image
\DeclareDocumentCommand{\SetMultiImageRoot}{m g g}
{
  % Set per row
  \FPeval{\MultiImagesPerRow}{clip(#1)} %

  \ifthenelse{\equal{\GetMultiImagesPerRow}{1}}%
  {%
    \FPeval{\WidthOfImagePerRow}{1} %
  } % End of if{}
  {%
    \FPeval{\WidthOfImagePerRow}{clip(clip(1 / \GetMultiImagesPerRow) - 0.05)} %
  } % End of else{}
} % End of \newcommand{}

\DeclareDocumentCommand{\SetMultiImageRootCaptionAndLabel}{m g g}
{
  \SetImageCaption{#2} %
  \SetImageLabel{#3} %
} % End of \newcommand{}

% Low-level insert image
\newcommand\ImageRotateAngle{0}
\newcommand{\SetImageRotateAngle}[1]
  {\renewcommand{\ImageRotateAngle}{#1}}
\newcommand{\GetImageRotateAngle}[0]{\ImageRotateAngle}

\newcommand{\InsertSubfigureImage}[4]
{%
  \begin{subfigure}[b]{\WidthOfImagePerRow\textwidth}%
    \center
    \includegraphics[scale=1.0, angle=#4]{#1}
    \SetImageCaption{#2}
    \SetImageLabel{#3}
  \end{subfigure}%
} % End of \newcommand{}

\newcommand{\InsertMultiImageInterface}[2]
{
  \ifthenelse{\equal{#2}{\empty}}
    {}
    {
      \SubfigureBreakSpaceLine{#1}
      \InsertMultiImageLL#2
    } % End of else{}
} % End of \newcommand{}

\DeclareDocumentCommand{\InsertMultiImageLL}{m g g g}
{
  \SetImageRotateAngle{0}
  \IfNoValueF{#4}{\SetImageRotateAngle{#4}}
  \InsertSubfigureImage{#1}{#2}{#3}{\ImageRotateAngle}%
} % End of \DeclareDocumentCommand{}

% Insert multi-image
% Arg: 1st: Table configure
%      2~9th: Images (Max 8 Images)
%
% ---------------------------------------
% 使用 \InsertMultiImageLL#2
% 是跟 \InsertMultiImageLL{#2} 不一樣的
% 直接連接#2是指把#2整個當成function的所有參數
% 而{#2}是指把#2當成單一個參數傳給function
% ---------------------------------------
%
\DeclareDocumentCommand{\InsertMultiImages}{%
  G{\empty} G{\empty} G{\empty} %
  G{\empty} G{\empty} G{\empty} %
  G{\empty} G{\empty} G{\empty}}
{
  \begin{figure}[hbtp]
    \centering
    \SetMultiImageRoot#1
    % Image 1
    \InsertMultiImageInterface{1}{#2}
    % Image 2
    \InsertMultiImageInterface{2}{#3}
    % Image 3
    \InsertMultiImageInterface{3}{#4}
    % Image 4
    \InsertMultiImageInterface{4}{#5}
    % Image 5
    \InsertMultiImageInterface{5}{#6}
    % Image 6
    \InsertMultiImageInterface{6}{#7}
    % Image 7
    \InsertMultiImageInterface{7}{#8}
    % Image 8
    \InsertMultiImageInterface{8}{#9}
    \SetMultiImageRootCaptionAndLabel#1
  \end{figure}
} % End of \DeclareDocumentCommand{}

% ----------------------------------------------------------------------------

